{
  "feature": "Storybook Feature Audit and Investigation",
  "workflow_type": "investigation",
  "workflow_rationale": "This task is primarily exploratory and diagnostic. We need to reproduce bugs, document root causes, verify working functionality, and create a findings report with recommendations before any fixes are implemented.",
  "phases": [
    {
      "id": "phase-1-reproduce",
      "name": "Reproduce Issues",
      "type": "investigation",
      "description": "Reproduce the reported bugs to confirm root causes and gather evidence",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Reproduce image upload persistence bug in CharacterSetupStep",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "investigation_steps": [
            "1. Navigate to Storybook feature and start new storybook (Generate mode)",
            "2. Enter character name and age",
            "3. Upload a character photo and observe the preview",
            "4. Click Next to proceed to category selection",
            "5. Click Back to return to character setup",
            "6. Check if image is still displayed",
            "7. Note: Also test by refreshing page after upload without clicking Next"
          ],
          "expected_output": "Document whether image persists or disappears, with console logs and network requests captured",
          "verification": {
            "type": "manual",
            "instructions": "Image persistence bug reproduced and documented with steps, screenshots, and console output"
          },
          "status": "completed",
          "notes": "Image upload persistence bug reproduced and documented. Root causes identified: 1) Delayed state sync - photo URL stored in local useState, only syncs to Zustand on Continue click. 2) Replicate temporary URLs may expire. Detailed reproduction scenarios and code evidence documented in build-progress.txt.",
          "updated_at": "2025-12-22T16:55:45.968726+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Reproduce character sheet generation block",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "investigation_steps": [
            "1. Navigate to Storybook feature and proceed to Characters step (step 8 in Generate mode)",
            "2. Add a new character without uploading a source photo",
            "3. Observe the Generate Character Sheet button state",
            "4. Document the disabled state and any message shown",
            "5. Attempt to understand why text-based generation is not available"
          ],
          "expected_output": "Document button disabled state, message shown, and confirm lack of text-based fallback",
          "verification": {
            "type": "manual",
            "instructions": "Character sheet block confirmed with evidence of disabled button and missing fallback"
          },
          "status": "completed",
          "notes": "Character sheet generation block reproduced and documented. Root causes identified: 1) Button disabled on line 338 when !sourcePhotoUrl, 2) \"Upload a photo first\" message shown on line 322, 3) Misleading header text promises \"generate from scratch\" option that doesn't exist, 4) Generation API could work without photo (conditional reference in useStorybookGeneration.ts) but UI blocks it. Recommended fixes documented including Option A (fix copy), Option B (add text-only generation), Option C (hybrid approach).",
          "updated_at": "2025-12-22T16:58:10.176514+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Verify Replicate URL expiration behavior",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "investigation_steps": [
            "1. Upload an image via /api/upload-file endpoint",
            "2. Note the returned URL format and domain",
            "3. Open URL in browser and confirm accessibility",
            "4. Wait 10 minutes and check URL again",
            "5. Wait 1 hour and check URL again (if possible)",
            "6. Research Replicate file URL expiration policy in documentation"
          ],
          "expected_output": "Document Replicate URL format, accessibility timeline, and official expiration policy",
          "verification": {
            "type": "manual",
            "instructions": "Replicate URL expiration behavior documented with evidence"
          },
          "status": "completed",
          "notes": "Replicate URL expiration behavior documented with evidence from official documentation and codebase. Key findings: 1) User uploads via files.create expire in 24 hours, 2) Model output URLs from replicate.delivery expire in 1 hour, 3) Codebase has partial mitigation (StorageService) but not applied to upload-file route or all storybook generations. Recommendations provided for permanent storage migration.",
          "updated_at": "2025-12-22T17:01:37.171537+00:00"
        }
      ]
    },
    {
      "id": "phase-2-investigate",
      "name": "Deep Investigation",
      "type": "investigation",
      "description": "Analyze code paths, state flow, and identify all root causes",
      "depends_on": [
        "phase-1-reproduce"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Analyze CharacterSetupStep state synchronization flow",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/features/storybook/components/wizard/steps/CharacterSetupStep.tsx"
          ],
          "investigation_steps": [
            "1. Trace local useState photoUrl initialization (line 25)",
            "2. Trace handlePhotoUpload flow - where does URL go after upload?",
            "3. Trace handleContinue - when is setMainCharacter called?",
            "4. Compare with store's setMainCharacter implementation",
            "5. Identify the gap: local state vs store state sync timing",
            "6. Document the exact failure mode"
          ],
          "expected_output": "Root cause analysis document with code references and recommended fix approach",
          "verification": {
            "type": "manual",
            "instructions": "State flow analysis complete with root cause identified"
          },
          "status": "completed",
          "notes": "Deep state flow analysis complete. Root causes identified: 1) Delayed sync - local useState only syncs to Zustand on Continue click, 2) No immediate persistence on upload, 3) Zustand in-memory only, 4) Replicate temporary URLs. Four failure modes documented. Four fix recommendations provided with priority ranking. Recommended Fix A (immediate store sync) as quick win, Fix D (Supabase storage) as permanent solution.",
          "updated_at": "2025-12-22T17:04:57.532282+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Analyze CharacterStep generation requirements",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/features/storybook/components/wizard/steps/CharacterStep.tsx"
          ],
          "investigation_steps": [
            "1. Trace the Generate Character Sheet button disabled condition (line 338)",
            "2. Analyze useStorybookGeneration hook generateCharacterSheet function",
            "3. Check if generation can work without sourcePhotoUrl",
            "4. Review AI prompt construction - is photo truly required?",
            "5. Research alternative character sheet generation approaches",
            "6. Document feasibility of text-only character generation"
          ],
          "expected_output": "Analysis of character sheet generation requirements with feasibility assessment for text-only mode",
          "verification": {
            "type": "manual",
            "instructions": "Character sheet generation analysis complete with recommendations"
          },
          "status": "completed",
          "notes": "Completed comprehensive analysis of CharacterStep generation requirements. Key findings: (1) Photo is required by UI but optional in API, (2) Header text is misleading, (3) Uses Replicate temp URLs, (4) Prompt assumes photo exists, (5) No error UI feedback, (6) No character description field for text-based generation. Documented 6 issues with prioritized recommendations in build-progress.txt.",
          "updated_at": "2025-12-22T17:08:20.811290+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Audit metadata structure and persistence gaps",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/features/storybook/store/storybook.store.ts",
            "src/features/storybook/types/storybook.types.ts"
          ],
          "investigation_steps": [
            "1. Document all fields in StorybookProject interface",
            "2. Document all fields in generatedStory object",
            "3. Identify which fields are educational/learning metadata",
            "4. Check current Supabase tables for any storybook persistence",
            "5. Document what metadata would be needed for recipe integration",
            "6. Assess gaps between current state and recipe requirements"
          ],
          "expected_output": "Metadata inventory document with fields, types, and recipe integration requirements",
          "verification": {
            "type": "manual",
            "instructions": "Metadata audit complete with inventory and gap analysis"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-verify-working",
      "name": "Verify Working Functionality",
      "type": "investigation",
      "description": "Confirm that core features are working correctly end-to-end",
      "depends_on": [
        "phase-1-reproduce"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Verify narration functionality end-to-end",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "src/features/storybook/components/AudioPlayer.tsx"
          ],
          "investigation_steps": [
            "1. Navigate to Preview step with story content",
            "2. Select a voice from the dropdown",
            "3. Click Generate Narration for current page",
            "4. Verify audio plays correctly",
            "5. Test Generate All Pages button",
            "6. Test playback controls (play, pause, skip, volume, speed)",
            "7. Check console for any errors"
          ],
          "expected_output": "Narration functionality verified with test results",
          "verification": {
            "type": "manual",
            "instructions": "Narration tested end-to-end with all controls verified"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Verify story generation flow (Generate mode)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "investigation_steps": [
            "1. Start new storybook in Generate mode",
            "2. Complete character setup (name, age)",
            "3. Select educational category",
            "4. Select specific topic",
            "5. Configure book settings (page count, sentences)",
            "6. Review generated story ideas and select one",
            "7. Review and edit generated story",
            "8. Verify story text is complete and appropriate"
          ],
          "expected_output": "Story generation flow verified with test results",
          "verification": {
            "type": "manual",
            "instructions": "Generate mode tested through story review step"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Verify page illustration generation",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "investigation_steps": [
            "1. Complete wizard to Pages step",
            "2. Generate page variations for a page",
            "3. Verify 3x3 grid of variations appears",
            "4. Select a variation and confirm it's applied",
            "5. Test style guide influence on generation",
            "6. Test character sheet influence on generation"
          ],
          "expected_output": "Page generation verified with variation selection working",
          "verification": {
            "type": "manual",
            "instructions": "Page generation tested with all features verified"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-document",
      "name": "Create Findings Report",
      "type": "implementation",
      "description": "Create comprehensive findings report with recommendations",
      "depends_on": [
        "phase-2-investigate",
        "phase-3-verify-working"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create INVESTIGATION_FINDINGS.md report",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            ".auto-claude/specs/002-audit-storybook-feature-and-investigate-issues/INVESTIGATION_FINDINGS.md"
          ],
          "patterns_from": [],
          "investigation_steps": [
            "1. Compile all reproduction results",
            "2. Document root causes for each issue",
            "3. List all working functionality verified",
            "4. Create prioritized fix recommendations",
            "5. Document metadata inventory for recipes",
            "6. Add implementation effort estimates"
          ],
          "expected_output": "Comprehensive INVESTIGATION_FINDINGS.md document",
          "verification": {
            "type": "command",
            "command": "test -f .auto-claude/specs/002-audit-storybook-feature-and-investigate-issues/INVESTIGATION_FINDINGS.md && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 9,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-1-reproduce",
            "phase-3-verify-working"
          ],
          "reason": "Both are independent investigation phases that don't modify code"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Investigation workflow benefits from sequential execution for coherent findings"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 002 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "low",
    "skip_validation": false,
    "test_creation_phase": "not_applicable",
    "test_types_required": [],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All reported bugs reproduced and documented",
      "Root causes identified for each issue",
      "Working functionality verified",
      "Findings report created with recommendations"
    ],
    "verification_steps": [
      {
        "name": "Findings Report Exists",
        "command": "test -f .auto-claude/specs/002-audit-storybook-feature-and-investigate-issues/INVESTIGATION_FINDINGS.md && echo 'OK'",
        "expected_outcome": "OK",
        "type": "file_check",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Investigation workflow - no code changes, only documentation and verification"
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": false,
      "commands": [],
      "services_to_test": []
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000",
          "checks": [
            "Navigate to Storybook feature",
            "Test wizard flow"
          ]
        },
        {
          "url": "Storybook wizard step 1",
          "checks": [
            "Test image upload",
            "Test navigation back"
          ]
        },
        {
          "url": "Storybook wizard step 8",
          "checks": [
            "Test character sheet generation",
            "Verify disabled state without photo"
          ]
        },
        {
          "url": "Storybook wizard step 10",
          "checks": [
            "Test narration generation",
            "Test playback controls"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "manual_testing_checklist": [
      "Image persistence bug reproduced",
      "Character sheet block confirmed",
      "Narration functionality verified",
      "Story generation flow verified",
      "Page generation verified",
      "Findings report reviewed"
    ]
  },
  "qa_signoff": null,
  "status": "human_review",
  "planStatus": "review",
  "updated_at": "2025-12-22T16:52:57.525Z",
  "last_updated": "2025-12-22T17:08:20.811299+00:00"
}