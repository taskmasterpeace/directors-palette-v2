{
  "file_path": "src/features/shot-creator/hooks/useGallerySelection.ts",
  "main_branch_history": [],
  "task_views": {
    "013-multi-select-gallery-with-bulk-actions": {
      "task_id": "013-multi-select-gallery-with-bulk-actions",
      "branch_point": {
        "commit_hash": "8654231a22984c33942f63d8839bdca5b0d017c2",
        "content": "",
        "timestamp": "2025-12-25T18:57:10.314069"
      },
      "worktree_state": {
        "content": "'use client'\n\nimport { useState, useCallback, useMemo, useRef } from 'react'\n\n/**\n * Extracts the ID from an item. Supports objects with 'id' property or string IDs directly.\n */\nfunction getItemId(item: { id: string } | string): string {\n  return typeof item === 'string' ? item : item.id\n}\n\n/**\n * Multi-select state management for gallery images using Set\n * Extends the usePromptSelection pattern with additional features:\n * - Set-based selectedIds tracking\n * - lastSelectedId ref for range selection support\n * - selectAll/selectNone/toggleSelect callbacks\n * - isSelected helper\n * - handleSelectWithModifiers for modifier-key selection:\n *   - Ctrl+click (Windows) or Cmd+click (Mac): Toggle individual item\n *   - Shift+click: Range selection between last selected and current item\n */\nexport function useGallerySelection() {\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())\n\n  // Track last selected item for range selection (Shift+click)\n  const lastSelectedIdRef = useRef<string | null>(null)\n\n  const selectAll = useCallback((imageIds: string[]) => {\n    setSelectedIds(new Set(imageIds))\n    // Update last selected to the last item in the list\n    if (imageIds.length > 0) {\n      lastSelectedIdRef.current = imageIds[imageIds.length - 1]\n    }\n  }, [])\n\n  const selectNone = useCallback(() => {\n    setSelectedIds(new Set())\n    lastSelectedIdRef.current = null\n  }, [])\n\n  const toggleSelect = useCallback((imageId: string) => {\n    setSelectedIds(prev => {\n      const next = new Set(prev)\n      if (next.has(imageId)) {\n        next.delete(imageId)\n      } else {\n        next.add(imageId)\n      }\n      return next\n    })\n    // Update last selected for subsequent range selections\n    lastSelectedIdRef.current = imageId\n  }, [])\n\n  const isSelected = useCallback((imageId: string) => {\n    return selectedIds.has(imageId)\n  }, [selectedIds])\n\n  const selectedCount = useMemo(() => selectedIds.size, [selectedIds])\n\n  // Getter for last selected ID (for range selection logic)\n  const getLastSelectedId = useCallback(() => {\n    return lastSelectedIdRef.current\n  }, [])\n\n  // Setter for last selected ID (used after range selection)\n  const setLastSelectedId = useCallback((id: string | null) => {\n    lastSelectedIdRef.current = id\n  }, [])\n\n  // Add multiple items to selection (used by range selection)\n  const addToSelection = useCallback((imageIds: string[]) => {\n    setSelectedIds(prev => {\n      const next = new Set(prev)\n      imageIds.forEach(id => next.add(id))\n      return next\n    })\n  }, [])\n\n  /**\n   * Handle selection with modifier keys.\n   * - Ctrl+click (Windows) or Cmd+click (Mac): Toggle individual item selection\n   * - Shift+click: Range selection between last selected and current item\n   * - Regular click: Toggle selection (fallback if no modifiers or no previous selection)\n   *\n   * @param itemId - The ID of the clicked item\n   * @param orderedItems - The full ordered list of items (can be objects with 'id' or strings)\n   * @param event - The mouse event to detect modifier keys\n   */\n  const handleSelectWithModifiers = useCallback((\n    itemId: string,\n    orderedItems: ({ id: string } | string)[],\n    event: React.MouseEvent\n  ) => {\n    const lastSelectedId = lastSelectedIdRef.current\n\n    // Check for Ctrl (Windows) or Cmd (Mac) key for explicit toggle\n    // metaKey is Cmd on Mac, ctrlKey is Ctrl on Windows/Linux\n    const isToggleModifier = event.ctrlKey || event.metaKey\n\n    // Handle Ctrl/Cmd+click for explicit toggle selection\n    // This takes priority over Shift+click (works independently of Shift key)\n    if (isToggleModifier) {\n      setSelectedIds(prev => {\n        const next = new Set(prev)\n        if (next.has(itemId)) {\n          next.delete(itemId)\n        } else {\n          next.add(itemId)\n        }\n        return next\n      })\n      // Update last selected for subsequent range selections\n      lastSelectedIdRef.current = itemId\n      return\n    }\n\n    // Handle Shift+click for range selection\n    if (event.shiftKey && lastSelectedId !== null) {\n      // Find indices of last selected and current item\n      const orderedIds = orderedItems.map(getItemId)\n      const lastIndex = orderedIds.indexOf(lastSelectedId)\n      const currentIndex = orderedIds.indexOf(itemId)\n\n      // If both items are found in the list, select the range\n      if (lastIndex !== -1 && currentIndex !== -1) {\n        // Determine start and end indices (works in both directions)\n        const startIndex = Math.min(lastIndex, currentIndex)\n        const endIndex = Math.max(lastIndex, currentIndex)\n\n        // Get all IDs in the range\n        const rangeIds = orderedIds.slice(startIndex, endIndex + 1)\n\n        // Add all items in range to selection (doesn't replace existing selection)\n        setSelectedIds(prev => {\n          const next = new Set(prev)\n          rangeIds.forEach(id => next.add(id))\n          return next\n        })\n\n        // Update last selected to the clicked item for subsequent range selections\n        lastSelectedIdRef.current = itemId\n        return\n      }\n    }\n\n    // Fallback: If no modifier keys, no previous selection, or items not found,\n    // behave like regular toggle selection\n    setSelectedIds(prev => {\n      const next = new Set(prev)\n      if (next.has(itemId)) {\n        next.delete(itemId)\n      } else {\n        next.add(itemId)\n      }\n      return next\n    })\n    lastSelectedIdRef.current = itemId\n  }, [])\n\n  return {\n    selectedIds,\n    selectedCount,\n    selectAll,\n    selectNone,\n    toggleSelect,\n    isSelected,\n    getLastSelectedId,\n    setLastSelectedId,\n    addToSelection,\n    handleSelectWithModifiers\n  }\n}\n",
        "last_modified": "2025-12-25T18:57:10.947737"
      },
      "task_intent": {
        "title": "013-multi-select-gallery-with-bulk-actions",
        "description": "Add multi-select mode to the unified image gallery with bulk actions toolbar (Download ZIP, Delete Selected, Move to Folder). Enable Shift+click for range selection and Ctrl+click for toggle selection.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T18:55:49.015532",
  "last_updated": "2025-12-25T18:57:10.902499"
}