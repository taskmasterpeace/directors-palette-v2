{
  "file_path": "src/features/shot-creator/components/unified-gallery/ImageCard.tsx",
  "main_branch_history": [],
  "task_views": {
    "013-multi-select-gallery-with-bulk-actions": {
      "task_id": "013-multi-select-gallery-with-bulk-actions",
      "branch_point": {
        "commit_hash": "8654231a22984c33942f63d8839bdca5b0d017c2",
        "content": "'use client'\n\nimport { useState, memo } from 'react'\nimport Image from \"next/image\"\nimport type { GeneratedImage } from \"../../store/unified-gallery-store\"\nimport type { FolderWithCount } from \"../../types/folder.types\"\nimport { useImageActions } from \"../../hooks/useImageActions\"\nimport { ImageActionMenu } from \"./ImageActionMenu\"\nimport { ModelBadge } from \"./ModelBadge\"\nimport { ReferenceBadge } from \"./ReferenceBadge\"\nimport { MetadataBar } from \"./MetadataBar\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport { cn } from \"@/utils/utils\"\nimport type { GridSize } from \"../../store/unified-gallery-store\"\nimport { AlertCircle, RefreshCw, Trash2 } from \"lucide-react\"\nimport { LoadingSpinner } from \"@/components/ui/loading-spinner\"\nimport { Button } from \"@/components/ui/button\"\n\ninterface ImageCardProps {\n  image: GeneratedImage\n  isSelected: boolean\n  onSelect: () => void\n  onZoom: () => void\n  onCopy: () => void\n  onDownload: () => void\n  onDelete: () => void\n  onSendTo?: (target: string) => void\n  onSetReference?: () => void\n  onEditReference?: () => void\n  onAddToLibrary?: () => void\n  onMoveToFolder?: (folderId: string | null) => void\n  onExtractFrames?: () => void\n  onExtractFramesToGallery?: () => void\n  onRemoveBackground?: () => void\n  isRemovingBackground?: boolean\n  currentFolderId?: string | null\n  folders?: FolderWithCount[]\n  showActions?: boolean\n  useNativeAspectRatio?: boolean\n  gridSize?: GridSize\n  onRetry?: () => void\n}\n\n/**\n * Image card component for gallery display\n * Displays image with overlays, badges, and action menu\n * Memoized to prevent unnecessary re-renders in large galleries\n */\nconst ImageCardComponent = ({\n  image,\n  isSelected,\n  onSelect,\n  onZoom,\n  onDownload,\n  onDelete,\n  onSendTo,\n  onSetReference,\n  onEditReference,\n  onAddToLibrary,\n  onMoveToFolder,\n  onExtractFrames,\n  onExtractFramesToGallery,\n  onRemoveBackground,\n  isRemovingBackground,\n  currentFolderId,\n  folders = [],\n  showActions = true,\n  useNativeAspectRatio = false,\n  gridSize = 'medium',\n  onRetry\n}: ImageCardProps) => {\n  const { handleCopyPrompt, handleCopyImage } = useImageActions()\n  const [dropdownOpen, setDropdownOpen] = useState(false)\n  const [imageLoadError, setImageLoadError] = useState(false)\n\n  // Check if image is still loading (pending/processing status)\n  const isLoading = image.status === 'pending' || image.status === 'processing'\n  const hasFailed = image.status === 'failed' || imageLoadError\n  // Note: completed state is the default render path (no explicit check needed)\n\n  // Render loading state\n  if (isLoading) {\n    return (\n      <div className=\"relative group rounded-lg overflow-hidden bg-card border border-border\">\n        <div className={cn(\n          \"w-full relative flex flex-col items-center justify-center bg-gradient-to-br from-violet-950/30 via-background to-fuchsia-950/20\",\n          useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n        )}>\n          {/* Animated loading spinner */}\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-full blur-xl opacity-30 animate-pulse\" />\n            <LoadingSpinner size=\"xl\" color=\"accent\" className=\"relative z-10\" />\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-3\">Generating...</p>\n          {image.prompt && (\n            <p className=\"text-xs text-muted-foreground/60 mt-1 px-4 text-center line-clamp-2 max-w-[200px]\">\n              {image.prompt.slice(0, 60)}...\n            </p>\n          )}\n        </div>\n        {/* Model badge for loading state */}\n        <ModelBadge model={image.model} />\n      </div>\n    )\n  }\n\n  // Render failed/error state\n  if (hasFailed) {\n    const isLoadError = imageLoadError && image.status !== 'failed'\n    return (\n      <div className=\"relative group rounded-lg overflow-hidden bg-card border-2 border-red-500/50\">\n        <div className={cn(\n          \"w-full relative flex flex-col items-center justify-center bg-gradient-to-br from-red-950/40 via-background to-red-950/30 p-3\",\n          useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n        )}>\n          <AlertCircle className=\"w-8 h-8 text-red-400 flex-shrink-0\" />\n          <p className=\"text-sm text-red-400 mt-2 font-medium text-center\">\n            {isLoadError ? 'Unavailable' : 'Failed'}\n          </p>\n          {image.metadata?.error && !isLoadError && (\n            <p className=\"text-xs text-muted-foreground mt-1 px-2 text-center line-clamp-1\">\n              {image.metadata.error}\n            </p>\n          )}\n          {/* Action buttons - always visible */}\n          <div className=\"flex gap-2 mt-3 flex-shrink-0\">\n            {onRetry && (\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={onRetry}\n                className=\"text-xs h-8 px-2 border-violet-500/50 hover:bg-violet-500/20 bg-violet-500/10\"\n              >\n                <RefreshCw className=\"w-3.5 h-3.5 mr-1\" />\n                Retry\n              </Button>\n            )}\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={onDelete}\n              className=\"text-xs h-8 px-2 border-red-500/50 hover:bg-red-500/20 bg-red-500/10 text-red-400\"\n            >\n              <Trash2 className=\"w-3.5 h-3.5 mr-1\" />\n              Remove\n            </Button>\n          </div>\n        </div>\n        {/* Model badge for failed state */}\n        <ModelBadge model={image.model} />\n      </div>\n    )\n  }\n\n  // Render completed state (normal image)\n  return (\n    <div className={`relative group rounded-lg overflow-hidden bg-card border transition-all ${isSelected ? 'border-primary border-2' : 'border-border hover:border-primary/50'}`}>\n      {/* Selection Checkbox */}\n      <div className={`absolute top-2 left-2 z-10 transition-opacity ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>\n        <Checkbox\n          checked={isSelected}\n          onCheckedChange={onSelect}\n          className=\"bg-background/80 border-border data-[state=checked]:bg-primary data-[state=checked]:border-primary\"\n        />\n      </div>\n\n      {/* Main image - toggle between square and native aspect ratio */}\n      <div className={cn(\n        \"w-full relative\",\n        useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n      )}>\n        <Image\n          src={image.url}\n          alt={image.prompt?.slice(0, 50) || 'Generated image'}\n          fill\n          sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 53vw\"\n          quality={100}\n          className={cn(\n            \"cursor-zoom-in\",\n            useNativeAspectRatio ? \"object-contain\" : \"object-cover\"\n          )}\n          onClick={onZoom}\n          onError={() => setImageLoadError(true)}\n        />\n      </div>\n\n      {/* Model icon badge */}\n      <ModelBadge model={image.model} />\n\n      {/* Reference badge if exists */}\n      <ReferenceBadge reference={image.reference || ''} />\n\n      {/* Action menu button - always visible on mobile, hover on desktop */}\n      {showActions && (\n        <div className=\"absolute top-2 right-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity\">\n          <ImageActionMenu\n            imageUrl={image.url}\n            prompt={image.prompt}\n            currentReference={image.reference}\n            currentFolderId={currentFolderId}\n            folders={folders}\n            onCopyPrompt={() => handleCopyPrompt(image.prompt)}\n            onCopyImage={() => handleCopyImage(image.url)}\n            onDownload={onDownload}\n            onDelete={onDelete}\n            onSendTo={onSendTo}\n            onSetReference={onSetReference}\n            onEditReference={onEditReference}\n            onAddToLibrary={onAddToLibrary}\n            onMoveToFolder={onMoveToFolder}\n            onExtractFrames={onExtractFrames}\n            onExtractFramesToGallery={onExtractFramesToGallery}\n            onRemoveBackground={onRemoveBackground}\n            isRemovingBackground={isRemovingBackground}\n            dropdownOpen={dropdownOpen}\n            onDropdownChange={setDropdownOpen}\n          />\n        </div>\n      )}\n\n      {/* Metadata bar - shows aspect ratio & resolution on hover */}\n      <MetadataBar\n        aspectRatio={image.settings.aspectRatio || image.settings.aspect_ratio || '16:9'}\n        resolution={image.settings.resolution || '1024x1024'}\n        gridSize={gridSize}\n      />\n    </div>\n  )\n}\n\n// Memoize component with custom comparison function\n// Only re-render if image data or selection state changes\nexport const ImageCard = memo(ImageCardComponent, (prevProps, nextProps) => {\n  return (\n    prevProps.image.id === nextProps.image.id &&\n    prevProps.image.url === nextProps.image.url &&\n    prevProps.image.status === nextProps.image.status &&\n    prevProps.isSelected === nextProps.isSelected &&\n    prevProps.showActions === nextProps.showActions &&\n    prevProps.useNativeAspectRatio === nextProps.useNativeAspectRatio &&\n    prevProps.gridSize === nextProps.gridSize\n  )\n})\n",
        "timestamp": "2025-12-25T18:57:10.314069"
      },
      "worktree_state": {
        "content": "'use client'\n\nimport { useState, memo } from 'react'\nimport Image from \"next/image\"\nimport type { GeneratedImage } from \"../../store/unified-gallery-store\"\nimport type { FolderWithCount } from \"../../types/folder.types\"\nimport { useImageActions } from \"../../hooks/useImageActions\"\nimport { ImageActionMenu } from \"./ImageActionMenu\"\nimport { ModelBadge } from \"./ModelBadge\"\nimport { ReferenceBadge } from \"./ReferenceBadge\"\nimport { MetadataBar } from \"./MetadataBar\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport { cn } from \"@/utils/utils\"\nimport type { GridSize } from \"../../store/unified-gallery-store\"\nimport { AlertCircle, RefreshCw, Trash2 } from \"lucide-react\"\nimport { LoadingSpinner } from \"@/components/ui/loading-spinner\"\nimport { Button } from \"@/components/ui/button\"\n\ninterface ImageCardProps {\n  image: GeneratedImage\n  isSelected: boolean\n  onSelect: (event?: React.MouseEvent) => void\n  onZoom: () => void\n  onCopy: () => void\n  onDownload: () => void\n  onDelete: () => void\n  onSendTo?: (target: string) => void\n  onSetReference?: () => void\n  onEditReference?: () => void\n  onAddToLibrary?: () => void\n  onMoveToFolder?: (folderId: string | null) => void\n  onExtractFrames?: () => void\n  onExtractFramesToGallery?: () => void\n  onRemoveBackground?: () => void\n  isRemovingBackground?: boolean\n  currentFolderId?: string | null\n  folders?: FolderWithCount[]\n  showActions?: boolean\n  useNativeAspectRatio?: boolean\n  gridSize?: GridSize\n  onRetry?: () => void\n}\n\n/**\n * Image card component for gallery display\n * Displays image with overlays, badges, and action menu\n * Memoized to prevent unnecessary re-renders in large galleries\n */\nconst ImageCardComponent = ({\n  image,\n  isSelected,\n  onSelect,\n  onZoom,\n  onDownload,\n  onDelete,\n  onSendTo,\n  onSetReference,\n  onEditReference,\n  onAddToLibrary,\n  onMoveToFolder,\n  onExtractFrames,\n  onExtractFramesToGallery,\n  onRemoveBackground,\n  isRemovingBackground,\n  currentFolderId,\n  folders = [],\n  showActions = true,\n  useNativeAspectRatio = false,\n  gridSize = 'medium',\n  onRetry\n}: ImageCardProps) => {\n  const { handleCopyPrompt, handleCopyImage } = useImageActions()\n  const [dropdownOpen, setDropdownOpen] = useState(false)\n  const [imageLoadError, setImageLoadError] = useState(false)\n\n  // Check if image is still loading (pending/processing status)\n  const isLoading = image.status === 'pending' || image.status === 'processing'\n  const hasFailed = image.status === 'failed' || imageLoadError\n  // Note: completed state is the default render path (no explicit check needed)\n\n  // Render loading state\n  if (isLoading) {\n    return (\n      <div className=\"relative group rounded-lg overflow-hidden bg-card border border-border\">\n        <div className={cn(\n          \"w-full relative flex flex-col items-center justify-center bg-gradient-to-br from-violet-950/30 via-background to-fuchsia-950/20\",\n          useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n        )}>\n          {/* Animated loading spinner */}\n          <div className=\"relative\">\n            <div className=\"absolute inset-0 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-full blur-xl opacity-30 animate-pulse\" />\n            <LoadingSpinner size=\"xl\" color=\"accent\" className=\"relative z-10\" />\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-3\">Generating...</p>\n          {image.prompt && (\n            <p className=\"text-xs text-muted-foreground/60 mt-1 px-4 text-center line-clamp-2 max-w-[200px]\">\n              {image.prompt.slice(0, 60)}...\n            </p>\n          )}\n        </div>\n        {/* Model badge for loading state */}\n        <ModelBadge model={image.model} />\n      </div>\n    )\n  }\n\n  // Render failed/error state\n  if (hasFailed) {\n    const isLoadError = imageLoadError && image.status !== 'failed'\n    return (\n      <div className=\"relative group rounded-lg overflow-hidden bg-card border-2 border-red-500/50\">\n        <div className={cn(\n          \"w-full relative flex flex-col items-center justify-center bg-gradient-to-br from-red-950/40 via-background to-red-950/30 p-3\",\n          useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n        )}>\n          <AlertCircle className=\"w-8 h-8 text-red-400 flex-shrink-0\" />\n          <p className=\"text-sm text-red-400 mt-2 font-medium text-center\">\n            {isLoadError ? 'Unavailable' : 'Failed'}\n          </p>\n          {image.metadata?.error && !isLoadError && (\n            <p className=\"text-xs text-muted-foreground mt-1 px-2 text-center line-clamp-1\">\n              {image.metadata.error}\n            </p>\n          )}\n          {/* Action buttons - always visible */}\n          <div className=\"flex gap-2 mt-3 flex-shrink-0\">\n            {onRetry && (\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={onRetry}\n                className=\"text-xs h-8 px-2 border-violet-500/50 hover:bg-violet-500/20 bg-violet-500/10\"\n              >\n                <RefreshCw className=\"w-3.5 h-3.5 mr-1\" />\n                Retry\n              </Button>\n            )}\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={onDelete}\n              className=\"text-xs h-8 px-2 border-red-500/50 hover:bg-red-500/20 bg-red-500/10 text-red-400\"\n            >\n              <Trash2 className=\"w-3.5 h-3.5 mr-1\" />\n              Remove\n            </Button>\n          </div>\n        </div>\n        {/* Model badge for failed state */}\n        <ModelBadge model={image.model} />\n      </div>\n    )\n  }\n\n  // Render completed state (normal image)\n  return (\n    <div className={`relative group rounded-lg overflow-hidden bg-card border transition-all ${isSelected ? 'border-primary border-2' : 'border-border hover:border-primary/50'}`}>\n      {/* Selection Checkbox */}\n      <div className={`absolute top-2 left-2 z-10 transition-opacity ${isSelected ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>\n        <Checkbox\n          checked={isSelected}\n          onClick={(e: React.MouseEvent) => {\n            e.stopPropagation()\n            onSelect(e)\n          }}\n          onCheckedChange={() => {\n            // Selection is handled by onClick to capture modifier keys\n          }}\n          className=\"bg-background/80 border-border data-[state=checked]:bg-primary data-[state=checked]:border-primary\"\n        />\n      </div>\n\n      {/* Main image - toggle between square and native aspect ratio */}\n      <div className={cn(\n        \"w-full relative\",\n        useNativeAspectRatio ? \"aspect-video\" : \"aspect-square\"\n      )}>\n        <Image\n          src={image.url}\n          alt={image.prompt?.slice(0, 50) || 'Generated image'}\n          fill\n          sizes=\"(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 53vw\"\n          quality={100}\n          className={cn(\n            \"cursor-zoom-in\",\n            useNativeAspectRatio ? \"object-contain\" : \"object-cover\"\n          )}\n          onClick={onZoom}\n          onError={() => setImageLoadError(true)}\n        />\n      </div>\n\n      {/* Model icon badge */}\n      <ModelBadge model={image.model} />\n\n      {/* Reference badge if exists */}\n      <ReferenceBadge reference={image.reference || ''} />\n\n      {/* Action menu button - always visible on mobile, hover on desktop */}\n      {showActions && (\n        <div className=\"absolute top-2 right-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity\">\n          <ImageActionMenu\n            imageUrl={image.url}\n            prompt={image.prompt}\n            currentReference={image.reference}\n            currentFolderId={currentFolderId}\n            folders={folders}\n            onCopyPrompt={() => handleCopyPrompt(image.prompt)}\n            onCopyImage={() => handleCopyImage(image.url)}\n            onDownload={onDownload}\n            onDelete={onDelete}\n            onSendTo={onSendTo}\n            onSetReference={onSetReference}\n            onEditReference={onEditReference}\n            onAddToLibrary={onAddToLibrary}\n            onMoveToFolder={onMoveToFolder}\n            onExtractFrames={onExtractFrames}\n            onExtractFramesToGallery={onExtractFramesToGallery}\n            onRemoveBackground={onRemoveBackground}\n            isRemovingBackground={isRemovingBackground}\n            dropdownOpen={dropdownOpen}\n            onDropdownChange={setDropdownOpen}\n          />\n        </div>\n      )}\n\n      {/* Metadata bar - shows aspect ratio & resolution on hover */}\n      <MetadataBar\n        aspectRatio={image.settings.aspectRatio || image.settings.aspect_ratio || '16:9'}\n        resolution={image.settings.resolution || '1024x1024'}\n        gridSize={gridSize}\n      />\n    </div>\n  )\n}\n\n// Memoize component with custom comparison function\n// Only re-render if image data or selection state changes\nexport const ImageCard = memo(ImageCardComponent, (prevProps, nextProps) => {\n  return (\n    prevProps.image.id === nextProps.image.id &&\n    prevProps.image.url === nextProps.image.url &&\n    prevProps.image.status === nextProps.image.status &&\n    prevProps.isSelected === nextProps.isSelected &&\n    prevProps.showActions === nextProps.showActions &&\n    prevProps.useNativeAspectRatio === nextProps.useNativeAspectRatio &&\n    prevProps.gridSize === nextProps.gridSize\n  )\n})\n",
        "last_modified": "2025-12-25T18:57:10.944392"
      },
      "task_intent": {
        "title": "013-multi-select-gallery-with-bulk-actions",
        "description": "Add multi-select mode to the unified image gallery with bulk actions toolbar (Download ZIP, Delete Selected, Move to Folder). Enable Shift+click for range selection and Ctrl+click for toggle selection.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T18:55:48.914126",
  "last_updated": "2025-12-25T18:57:10.794841"
}